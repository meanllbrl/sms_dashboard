<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Notion Light Mode */
            --bg-primary: #ffffff;
            --card-bg: #ffffff;
            --text-primary: #37352f;
            --text-secondary: #787774;
            --text-muted: #9b9a97;
            --border-color: rgba(227, 226, 224, 0.5);
            --shadow: 0 1px 1px rgba(15, 15, 15, 0.05);
            --hover-shadow: 0 2px 4px rgba(15, 15, 15, 0.08);
            
            /* Notion-native subtle accent colors */
            --accent-default: #37352f;
            --accent-gray: #787774;
            --accent-brown: #9f6b53;
            --accent-orange: #d9730d;
            --accent-yellow: #cb912f;
            --accent-green: #448361;
            --accent-blue: #337ea9;
            --accent-purple: #9065b0;
            --accent-pink: #c14c8a;
            --accent-red: #d44c47;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Notion Dark Mode */
                --bg-primary: #191919;
                --card-bg: #191919;
                --text-primary: rgba(255, 255, 255, 0.9);
                --text-secondary: rgba(255, 255, 255, 0.6);
                --text-muted: rgba(255, 255, 255, 0.4);
                --border-color: rgba(255, 255, 255, 0.09);
                --shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
                --hover-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
                
                /* Dark mode accents */
                --accent-default: rgba(255, 255, 255, 0.9);
                --accent-gray: #9b9a97;
                --accent-brown: #ba856f;
                --accent-orange: #e8a567;
                --accent-yellow: #e0af63;
                --accent-green: #579668;
                --accent-blue: #529cca;
                --accent-purple: #ab7cd1;
                --accent-pink: #dd7fa6;
                --accent-red: #e87b76;
            }
        }

        body {
            font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .dashboard-container {
            width: 100%;
            height: 100%;
            max-height: 100vh;
            padding: clamp(12px, 2.5vh, 24px) clamp(10px, 2.5vh, 24px) clamp(8px, 1.5vh, 14px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 2vh, 20px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: clamp(12px, 2.5vh, 24px);
            width: 100%;
            flex: 2;
            min-height: 0;
        }

        .bottom-section {
            display: flex;
            gap: clamp(12px, 2.5vh, 24px);
            align-items: center;
            width: 100%;
            flex-shrink: 0;
            min-height: 0;
        }

        .list-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: clamp(10px, 2vh, 18px);
            flex: 1;
            min-height: 0;
            min-width: 0;
        }

        .list-item {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: clamp(8px, 1.2vh, 14px);
            padding: clamp(10px, 1.8vh, 20px) clamp(12px, 2vw, 24px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        .list-item:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .list-item-label {
            font-size: clamp(10px, 1.6vh, 16px);
            font-weight: 600;
            color: var(--text-secondary);
            opacity: 0.95;
        }

        .list-item-value {
            font-size: clamp(14px, 2.2vh, 22px);
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark, var(--accent-color)) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: clamp(10px, 1.8vh, 20px);
            padding: clamp(14px, 3.5vh, 40px) clamp(12px, 3vw, 36px);
            width: 100%;
            height: 100%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--border-color);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-color-light, var(--accent-color)));
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .metric-card:hover {
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.1), 0 6px 10px rgba(0, 0, 0, 0.08);
            transform: translateY(-4px);
            border-color: var(--accent-color);
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            flex-direction: column;
            gap: clamp(4px, 1vh, 10px);
            flex-shrink: 0;
        }

        .card-title {
            font-size: clamp(10px, 2vh, 20px);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: clamp(0.6px, 0.3vw, 2.2px);
            color: var(--accent-color);
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: clamp(5px, 1vw, 12px);
        }

        .card-title::before {
            content: '';
            width: clamp(6px, 1.4vh, 14px);
            height: clamp(6px, 1.4vh, 14px);
            border-radius: 50%;
            background: var(--accent-color);
            opacity: 0.85;
            flex-shrink: 0;
        }

        .card-subtitle {
            font-size: clamp(10px, 2vh, 20px);
            color: var(--text-secondary);
            font-weight: 600;
            line-height: 1.3;
            opacity: 0.95;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.2vw, 14px);
            flex-wrap: wrap;
            transition: color 0.2s ease;
        }

        .card-subtitle:hover {
            color: var(--accent-color);
        }

        .dropdown-select {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: clamp(6px, 1.4vh, 14px);
            padding: clamp(4px, 1vh, 10px) clamp(8px, 1.8vw, 16px);
            font-size: clamp(9px, 1.6vh, 16px);
            font-weight: 700;
            cursor: pointer;
            outline: none;
            transition: all 0.25s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23337ea9' stroke='%23337ea9' stroke-width='0.5' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right clamp(6px, 1.4vw, 14px) center;
            background-size: clamp(10px, 1.8vh, 16px);
            padding-right: clamp(26px, 3.5vw, 40px);
            opacity: 0.95;
        }

        .dropdown-select:hover {
            background-color: var(--accent-color);
            color: var(--card-bg);
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            .dropdown-select:hover {
                background-color: var(--accent-color);
                color: var(--bg-primary);
            }
        }

        .metric-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: clamp(6px, 2.5vh, 20px) 0;
        }

        .metric-value {
            font-size: clamp(24px, 7.5vh, 76px);
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark, var(--accent-color)) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 0.95;
            letter-spacing: -0.04em;
            font-variant-numeric: tabular-nums;
        }

        .metric-suffix {
            font-size: clamp(10px, 2.2vh, 22px);
            font-weight: 700;
            color: var(--accent-color);
            opacity: 0.85;
            margin-left: clamp(3px, 1vw, 12px);
        }

        /* Modern gradient color variants */
        .card-blue {
            --accent-color: #3b82f6;
            --accent-color-dark: #2563eb;
            --accent-color-light: #60a5fa;
        }
        .card-green {
            --accent-color: #10b981;
            --accent-color-dark: #059669;
            --accent-color-light: #34d399;
        }
        .card-orange {
            --accent-color: #f59e0b;
            --accent-color-dark: #d97706;
            --accent-color-light: #fbbf24;
        }
        .card-purple {
            --accent-color: #8b5cf6;
            --accent-color-dark: #7c3aed;
            --accent-color-light: #a78bfa;
        }
        .card-pink {
            --accent-color: #ec4899;
            --accent-color-dark: #db2777;
            --accent-color-light: #f472b6;
        }
        .card-brown {
            --accent-color: #a16207;
            --accent-color-dark: #854d0e;
            --accent-color-light: #ca8a04;
        }
        .card-red {
            --accent-color: #dc2626;
            --accent-color-dark: #b91c1c;
            --accent-color-light: #ef4444;
        }

        /* Reload button - divider style */
        .reload-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .reload-btn {
            width: clamp(44px, 6vh, 60px);
            height: clamp(44px, 6vh, 60px);
            border-radius: 50%;
            background: var(--card-bg);
            border: 2.5px solid var(--border-color);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .reload-btn:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: scale(1.05);
        }

        .reload-icon {
            width: clamp(20px, 3.2vh, 30px);
            height: clamp(20px, 3.2vh, 30px);
            stroke: var(--text-primary);
            stroke-width: 2.5;
            fill: none;
            transition: stroke 0.3s ease;
        }

        .reload-btn:hover .reload-icon {
            stroke: var(--accent-blue);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .reload-btn.spinning .reload-icon {
            animation: spin 0.6s linear;
        }

        /* Responsive - Better tablet handling */
        @media (max-width: 1024px) and (min-width: 769px) {
            .dashboard-container {
                padding: clamp(14px, 2.5vh, 20px) clamp(12px, 2vw, 18px);
            }
            
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: clamp(10px, 2vh, 18px);
            }
        }

        @media (max-width: 768px) and (min-width: 601px) {
            .dashboard-container {
                padding: clamp(10px, 2vh, 16px) clamp(10px, 2vw, 16px);
            }
            
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: clamp(8px, 1.8vh, 14px);
            }
            
            .metric-card {
                padding: clamp(10px, 2.5vh, 20px) clamp(10px, 2vw, 16px);
            }
            
            .card-title {
                font-size: clamp(9px, 1.7vh, 15px);
            }
            
            .card-subtitle {
                font-size: clamp(9px, 1.7vh, 15px);
            }
            
            .dropdown-select {
                font-size: clamp(8px, 1.4vh, 12px);
            }
            
            .metric-value {
                font-size: clamp(22px, 6.5vh, 56px);
            }
            
            .list-item-label {
                font-size: clamp(9px, 1.4vh, 13px);
            }
            
            .list-item-value {
                font-size: clamp(12px, 1.9vh, 18px);
            }
        }

        @media (max-width: 600px) {
            body {
                overflow: hidden;
            }
            
            .dashboard-container {
                padding: clamp(8px, 1.5vh, 12px);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
            
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: clamp(6px, 1.2vh, 10px);
            }
            
            .bottom-section {
                flex-direction: row;
                gap: clamp(6px, 1vh, 10px);
                flex-wrap: nowrap;
                align-items: stretch;
            }
            
            .list-metrics {
                width: calc((100% - clamp(32px, 4vh, 40px) - clamp(12px, 2vh, 20px)) / 2);
                flex-shrink: 1;
            }
            
            .reload-divider {
                width: clamp(32px, 4vh, 40px);
                flex-shrink: 0;
                align-self: center;
            }
            
            .list-metrics {
                gap: clamp(4px, 0.8vh, 6px);
                grid-template-rows: repeat(2, minmax(0, 1fr));
            }
            
            .list-item {
                padding: clamp(5px, 1vh, 8px) clamp(6px, 1.2vw, 10px);
                min-height: 0;
            }
            
            .list-item-label {
                font-size: clamp(7px, 1.1vh, 9px);
                line-height: 1.2;
            }
            
            .list-item-value {
                font-size: clamp(10px, 1.6vh, 14px);
                white-space: nowrap;
            }
            
            .reload-btn {
                width: clamp(36px, 4.5vh, 48px);
                height: clamp(36px, 4.5vh, 48px);
            }
            
            .reload-icon {
                width: clamp(16px, 2.5vh, 22px);
                height: clamp(16px, 2.5vh, 22px);
            }
            
            .metric-card {
                padding: clamp(8px, 1.8vh, 14px) clamp(8px, 2vw, 12px);
                border-radius: clamp(6px, 1vh, 10px);
            }
            
            .card-header {
                gap: clamp(2px, 0.5vh, 4px);
            }
            
            .card-title {
                font-size: clamp(9px, 1.6vh, 13px);
                letter-spacing: 0.3px;
                gap: clamp(3px, 0.5vw, 5px);
            }
            
            .card-title::before {
                width: clamp(4px, 0.8vh, 6px);
                height: clamp(4px, 0.8vh, 6px);
            }
            
            .card-subtitle {
                font-size: clamp(8px, 1.4vh, 11px);
                gap: clamp(3px, 0.8vw, 6px);
                line-height: 1.1;
            }
            
            .dropdown-select {
                font-size: clamp(7px, 1.2vh, 9px);
                padding: clamp(2px, 0.4vh, 3px) clamp(4px, 1vw, 6px);
                padding-right: clamp(14px, 2vw, 18px);
                border-width: 1px;
                border-radius: clamp(3px, 0.6vh, 5px);
                background-size: clamp(6px, 1vh, 8px);
                background-position: right clamp(3px, 0.6vw, 5px) center;
            }
            
            .metric-display {
                padding: clamp(3px, 1vh, 8px) 0;
            }
            
            .metric-value {
                font-size: clamp(22px, 5.5vh, 44px);
                line-height: 0.9;
            }
            
            .metric-suffix {
                font-size: clamp(8px, 1.6vh, 13px);
                margin-left: clamp(2px, 0.4vw, 4px);
            }
            
            .reload-btn {
                width: clamp(32px, 4vh, 40px);
                height: clamp(32px, 4vh, 40px);
                border-width: 2px;
            }
            
            .reload-icon {
                width: clamp(14px, 2vh, 18px);
                height: clamp(14px, 2vh, 18px);
                stroke-width: 2;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: clamp(6px, 1.2vh, 10px);
                gap: clamp(8px, 1.5vh, 12px);
            }
            
            .cards-grid {
                gap: clamp(5px, 1vh, 8px);
            }
            
            .metric-value {
                font-size: clamp(20px, 5vh, 38px);
            }
            
            .bottom-section {
                gap: clamp(4px, 0.8vh, 6px);
            }
            
            .list-metrics {
                gap: clamp(3px, 0.6vh, 5px);
                width: calc((100% - clamp(32px, 4vh, 40px) - clamp(8px, 1.6vh, 12px)) / 2);
            }
        }

        @media (orientation: portrait) and (max-width: 600px) {
            .dashboard-container {
                gap: clamp(10px, 1.8vh, 16px);
            }
            
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: clamp(8px, 1.5vh, 12px);
            }
            
            .bottom-section {
                gap: clamp(8px, 1.2vh, 12px);
            }
        }

        .loading, .error, .unauthorized {
            text-align: center;
            padding: clamp(20px, 4vh, 40px) clamp(10px, 2vw, 20px);
            color: var(--text-secondary);
            font-size: clamp(12px, 1.8vh, 16px);
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error { color: var(--accent-red); }
        .unauthorized { color: var(--text-muted); }

        /* Subtle fade-in */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .metric-card {
            animation: fadeIn 0.35s ease-out backwards;
        }

        .metric-card:nth-child(1) { animation-delay: 0.05s; }
        .metric-card:nth-child(2) { animation-delay: 0.1s; }
        .metric-card:nth-child(3) { animation-delay: 0.15s; }
        .metric-card:nth-child(4) { animation-delay: 0.2s; }
        .metric-card:nth-child(5) { animation-delay: 0.25s; }
        .metric-card:nth-child(6) { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="dashboard-content" class="cards-grid">
            <div class="loading">Yükleniyor...</div>
        </div>
        
        <div class="bottom-section">
            <div id="list-metrics-left" class="list-metrics">
                <!-- Left list items will be inserted here -->
            </div>
            
            <div class="reload-divider">
                <button class="reload-btn" onclick="reloadData()" title="Yenile">
                    <svg class="reload-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <div id="list-metrics-right" class="list-metrics">
                <!-- Right list items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Get parameters from URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                key: params.get('key'),
                endpoint: params.get('endpoint')
            };
        }

        // Decode endpoint from base64
        function decodeEndpoint(encoded) {
            try {
                return atob(encoded);
            } catch {
                return null;
            }
        }

        // Check authorization
        function isAuthorized() {
            const { key, endpoint } = getUrlParams();
            return key && key.length > 0 && endpoint && endpoint.length > 0;
        }

        // Show unauthorized message
        function showUnauthorized() {
            document.getElementById('dashboard-content').innerHTML = 
                '<div class="unauthorized">Erişim reddedildi</div>';
        }

        const metricGroups = {
            activeStudents: {
                title: 'Öğrenci Sayısı',
                colorClass: 'card-blue',
                metrics: [
                    { key: 'activeStudentCount', label: 'Aktif Öğrenci', format: 'number', suffix: '' }
                ]
            },
            recurringRevenue: {
                title: 'Yinelenen Gelirler',
                colorClass: 'card-green',
                metrics: [
                    { key: 'mrr', label: 'Aylık Tekrarlayan Gelir', format: 'currency', suffix: 'MRR' },
                    { key: 'arr', label: 'Yıllık Tekrarlayan Gelir', format: 'currency', suffix: 'ARR' },
                    { key: 'wrr', label: 'Haftalık Tekrarlayan Gelir', format: 'currency', suffix: 'WRR' }
                ]
            },
            totalRevenue: {
                title: 'Kazanılan Toplam Gelir',
                colorClass: 'card-green',
                metrics: [
                    { key: 'totalRevenue', label: 'Toplam Gelir', format: 'currency', suffix: 'Toplam' }
                ]
            },
            ltv: {
                title: 'Öğrenci Değeri',
                colorClass: 'card-purple',
                metrics: [
                    { key: 'cltv', label: 'Yaşam Boyu Değer', format: 'currency', suffix: 'LTV' },
                    { key: 'averageRevenuePerStudent', label: 'Ortalama Gelir', format: 'currency', suffix: 'ARPU' }
                ]
            },
            cac: {
                title: 'Edinim Maliyeti',
                colorClass: 'card-orange',
                metrics: [
                    { key: 'cac', label: 'Öğrenci Edinim Maliyeti', format: 'currency', suffix: 'CAC' },
                    { key: 'cltv_cac_ratio', label: 'LTV/CAC Oranı', format: 'decimal', suffix: 'x' }
                ]
            },
            efficiency: {
                title: 'Verimlilik',
                colorClass: 'card-brown',
                metrics: [
                    { key: 'averageHourlyRate', label: 'Saatlik Ortalama Gelir', format: 'currency', suffix: '₺/saat' },
                    { key: 'monthlyAverageRevenue', label: 'Aylık Ortalama', format: 'currency', suffix: 'Ort.' }
                ]
            }
        };

        const listMetrics = [
            { key: 'avgWeeklyFrequency', label: 'Haftalık Ders Sayısı', format: 'decimal', suffix: ' ders', colorClass: 'card-pink' },
            { key: 'averageSessionLength', label: 'Ortalama Ders Süresi', format: 'decimal', suffix: ' dk', colorClass: 'card-pink' },
            { key: 'churnedUserPercentage', label: 'Ayrılan Öğrenci', format: 'percentage', suffix: '%', colorClass: 'card-red' },
            { key: 'cltv_cac_ratio', label: 'LTV/CAC Oranı', format: 'decimal', suffix: 'x', colorClass: 'card-orange' }
        ];

        function formatValue(value, format) {
            if (value === null || value === undefined) return '-';
            
            // Check if screen is narrow (mobile)
            const isNarrow = window.innerWidth < 600;
            
            switch(format) {
                case 'currency':
                    // Shorten large numbers on narrow screens
                    if (isNarrow) {
                        if (value >= 1000000) {
                            return (value / 1000000).toFixed(1).replace('.', ',') + 'M';
                        } else if (value >= 10000) {
                            return (value / 1000).toFixed(1).replace('.', ',') + 'k';
                        }
                    }
                    const formatted = new Intl.NumberFormat('tr-TR', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                    return formatted.replace(/\./g, ',');
                    
                case 'percentage':
                    return value.toFixed(1);
                    
                case 'decimal':
                    return value.toFixed(2);
                    
                case 'number':
                default:
                    if (isNarrow && value >= 1000) {
                        return (value / 1000).toFixed(1).replace('.', ',') + 'k';
                    }
                    return new Intl.NumberFormat('tr-TR').format(value);
            }
        }

        function createMetricCard(groupKey, groupConfig, data, selectedIndex = 0) {
            const metric = groupConfig.metrics[selectedIndex];
            const value = data[metric.key];
            const formattedValue = formatValue(value, metric.format);
            const hasDropdown = groupConfig.metrics.length > 1;
            
            let displayValue = formattedValue;
            let displaySuffix = metric.suffix;
            
            if (metric.format === 'currency' && !metric.suffix.includes('₺') && !metric.suffix.includes('/saat')) {
                displayValue = '₺' + formattedValue;
            } else if (metric.suffix === '₺/saat') {
                displayValue = '₺' + formattedValue;
                displaySuffix = '/saat';
            }
            
            // Calculate LTV/CAC ratio if both exist
            if (metric.key === 'cltv_cac_ratio') {
                const ratio = data.cltv && data.cac ? (data.cltv / data.cac).toFixed(2) : '-';
                return `
                    <div class="metric-card ${groupConfig.colorClass}">
                        <div class="card-header">
                            <div class="card-title">${groupConfig.title}</div>
                            <div class="card-subtitle">
                                ${metric.label}
                                ${hasDropdown ? `
                                    <select class="dropdown-select" onchange="updateMetric('${groupKey}', this.value)">
                                        ${groupConfig.metrics.map((m, idx) => `
                                            <option value="${idx}" ${idx === selectedIndex ? 'selected' : ''}>
                                                ${m.suffix}
                                            </option>
                                        `).join('')}
                                    </select>
                                ` : ''}
                            </div>
                        </div>
                        <div class="metric-display">
                            <div class="metric-value">
                                ${ratio}<span class="metric-suffix">${displaySuffix}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="metric-card ${groupConfig.colorClass}">
                    <div class="card-header">
                        <div class="card-title">${groupConfig.title}</div>
                        <div class="card-subtitle">
                            ${metric.label}
                            ${hasDropdown ? `
                                <select class="dropdown-select" onchange="updateMetric('${groupKey}', this.value)">
                                    ${groupConfig.metrics.map((m, idx) => `
                                        <option value="${idx}" ${idx === selectedIndex ? 'selected' : ''}>
                                            ${m.suffix}
                                        </option>
                                    `).join('')}
                                </select>
                            ` : ''}
                        </div>
                    </div>
                    <div class="metric-display">
                        <div class="metric-value">
                            ${displayValue}<span class="metric-suffix">${displaySuffix}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        let currentSelections = {
            activeStudents: 0,
            recurringRevenue: 0,
            totalRevenue: 0,
            ltv: 0,
            cac: 0,
            efficiency: 0
        };

        function createListItem(metric, data) {
            let value = data[metric.key];
            
            // Calculate LTV/CAC ratio if needed
            if (metric.key === 'cltv_cac_ratio') {
                value = data.cltv && data.cac ? (data.cltv / data.cac) : 0;
            }
            
            const formattedValue = formatValue(value, metric.format);
            const displayValue = formattedValue + metric.suffix;
            
            return `
                <div class="list-item ${metric.colorClass}">
                    <span class="list-item-label">${metric.label}</span>
                    <span class="list-item-value">${displayValue}</span>
                </div>
            `;
        }

        function renderDashboard(data) {
            // Calculate total revenue if not provided
            if (!data.totalRevenue) {
                data.totalRevenue = (data.mrr || 0) * 12; // Simple estimate: MRR * 12
            }
            
            // Render grid cards
            const container = document.getElementById('dashboard-content');
            const cards = Object.entries(metricGroups).map(([key, config]) => 
                createMetricCard(key, config, data, currentSelections[key])
            ).join('');
            container.innerHTML = cards;
            
            // Render list metrics (split into left and right)
            const leftContainer = document.getElementById('list-metrics-left');
            const rightContainer = document.getElementById('list-metrics-right');
            
            const leftItems = listMetrics.slice(0, 2).map(metric => createListItem(metric, data)).join('');
            const rightItems = listMetrics.slice(2, 4).map(metric => createListItem(metric, data)).join('');
            
            leftContainer.innerHTML = leftItems;
            rightContainer.innerHTML = rightItems;
        }

        let cachedData = null;

        function updateMetric(groupKey, selectedIndex) {
            currentSelections[groupKey] = parseInt(selectedIndex);
            if (cachedData) {
                renderDashboard(cachedData);
            }
        }

        // Reload data with animation
        function reloadData() {
            const btn = document.querySelector('.reload-btn');
            btn.classList.add('spinning');
            
            fetchData().then(() => {
                setTimeout(() => {
                    btn.classList.remove('spinning');
                }, 600);
            });
        }

        // Fetch data with authorization
        async function fetchData() {
            if (!isAuthorized()) {
                showUnauthorized();
                return Promise.resolve();
            }

            const { key, endpoint } = getUrlParams();
            const decodedEndpoint = decodeEndpoint(endpoint);
            
            if (!decodedEndpoint) {
                document.getElementById('dashboard-content').innerHTML = 
                    '<div class="error">Yapılandırma hatası</div>';
                return Promise.resolve();
            }

            try {
                // Try direct fetch first (in case CORS is configured)
                let response;
                try {
                    response = await fetch(decodedEndpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Basic ${key}`
                        }
                    });
                } catch (corsError) {
                    // If CORS fails, try with proxy
                    const proxyUrl = `https://thingproxy.freeboard.io/fetch/${decodedEndpoint}`;
                    response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Basic ${key}`
                        }
                    });
                }

                if (!response.ok) {
                    throw new Error('Veri alınamadı');
                }

                const data = await response.json();
                cachedData = data;
                renderDashboard(cachedData);
                return Promise.resolve();
            } catch (error) {
                document.getElementById('dashboard-content').innerHTML = 
                    '<div class="error">Veri yüklenemedi</div>';
                console.error('Fetch error:', error);
                return Promise.resolve();
            }
        }

        // Initialize on load
        if (isAuthorized()) {
            fetchData();
            // Auto-refresh every minute
            setInterval(fetchData, 60000);
            
            // Re-render on window resize to update number formatting
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (cachedData) {
                        renderDashboard(cachedData);
                    }
                }, 250);
            });
        } else {
            showUnauthorized();
        }
    </script>
</body>
</html>
